<html>
    <head>
        <title>신조어 번역기</title>
        <link rel="icon" href="images/browser_icon.png">
        <meta name="google-site-verification" content="zMl9VCgCmbPQSoWANnwgfH-JeM1T6Gzwcu40sNA6z4Q" />
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" type="text/css" href="style.css?aftersfddas">
        <link href='//spoqa.github.io/spoqa-han-sans/css/SpoqaHanSans-kr.css' rel='stylesheet' type='text/css'>
        <script src="jquery-3.4.1.js"></script>
    </head>
    
    <body>
        <header>
            <div id="emptyBox"></div>
            <div id="titleBox">
                <a href="http://125.180.32.198" id="titleLogoLinker"><img src="images/title.png" id="titleLogo" alt="Title"></a>
                <div>
                    <a href="/adding"><span>신조어 등록</span></a>
                </div>
            </div>
        </header>
        <article>
            <div id="inputBox">
                <div>
                    <form action="index.py">
                        <span id="coinSentenceInputTitle">신조어</span>
                        <textarea name="coinSentence" placeholder="신조어를 입력하세요." maxlength="100" id="coinSentenceInput" oninput="document.getElementById('textLength').textContent=document.getElementById('coinSentenceInput').value.length.toString() + '/' + document.getElementById('coinSentenceInput').maxLength.toString();inspectTime()" onkeydown="resize(this)" onfocus="document.getElementById('coinSentenceInputTitle').className='coinSentenceInputButtonClassHover';document.getElementById('coinSentenceInputButtons').className='coinSentenceInputButtonsClassHover'" onfocusout="document.getElementById('coinSentenceInputTitle').className='coinSentenceInputButtonClass';document.getElementById('coinSentenceInputButtons').className='coinSentenceInputButtonsClass'" autofocus></textarea>
                    </form>
                    <div id="coinSentenceInputButtons" class="coinSentenceInputButtonsClass">
                        <button type="button" onclick="request_input_by_button(document.getElementById('coinSentenceInput').value);">번역</button>
                        <span id="textLength">0/100</span>
                        <button type="imagebutton" onclick="TTS(document.getElementById('coinSentenceInput').value);" title="듣기"><img src="images/speaker.png" width=27></button>
                    </div>
                </div>

                <div>
                    <form action="index.py">
                        <span>순화어</span>
                        <textarea name="decl" id="translateResultInput" oninput="resize(this)" readonly></textarea>
                    </form>
                    <div id="coinSentenceResultButtons" class="coinSentenceResultButtonsClass">
                        <button type="imagebutton" onclick="TTS(document.getElementById('translateResultInput').value);" title="듣기"><img src="images/speaker.png" width=27></button>
                        <button type="imagebutton" onclick="declare();" title="번역 오류 신고"><img src="images/decl.png" width=27></button>
                    </div>
                </div>
            </div>
        </article>
        <footer>
            <div id="icons">
                <a href="/twitter_redirect.html" class="icon-twitter"><img src="images/twitterIcon.png" alt="Twitter" width=35></a>
                <a href="/facebook_redirect.html" class="icon-facebook"><img src="images/facebookIcon.png" alt="Facebook" width=35></a>
                <a href="/kakaostory_redirect.html" class="icon-kakaostory"><img src="images/kakaostoryIcon.png" alt="KakaoStory" width=35></a>
            </div>
        </footer>
        <script type="text/javascript">
            // console에 logging image
            (function(url) {
                  var image = new Image();

                  image.onload = function() {
                      var style = [
                          'font-size: 1px;',
                          'line-height: ' + this.height + 'px;',
                          'padding: 0px ' + this.width * .46 + 'px;',
                          'background-size: ' + this.width + 'px ' + this.height + 'px;',
                          'background: url('+ url +');'
                      ].join(' ');
                      console.log('%c ', style);
                  };
                image.src = url;
            })('/images/title_s.png');

            // coinSentenceInput의 내용 유지 + 커서를 제일 오른쪽으로
            
            isDottedOnCoinSentenceInput = false;  // coinSentenceInput 뒤에 ...이 붙어 있는가? 
            inspectTimeCount = 0;
            nowCanRequestInput = true;
            
            socket = new WebSocket("ws://125.180.32.198:7404");
            socket.onmessage = function(event) {
                var recv_data = decodeURIComponent(event.data);
                var recv_json = eval("(" + recv_data + ")");
                if (recv_json["type"] === "translate_result") {
                    $("#translateResultInput").text(recv_json["text"]);
                    lastTranslateHistory = [recv_json["requested_text"], recv_json["text"]];
                }
            }
            
            // websocket에 신조어 번역 요청
            function request_input(coinSentence) {
                if (nowCanRequestInput) {
                    socket.send(encodeURIComponent(coinSentence));
                    nowCanRequestInput = false;
                    setTimeout(function() {
                        nowCanRequestInput = true;
                    }, 1500);
                }
            }
            function request_input_by_button(value) {
                var json = {"type": "request_translate", "text": value};
                request_input(JSON.stringify(json));
            }
            
            // coinSentenceInput에 입력한 후 0.5초동안 가만히 있으면 translate 요청
            function inspectTime() {
                if (!isDottedOnCoinSentenceInput) { // coinSentenceInput 뒤에 ...이 붙이기
                    //document.getElementById('translateResultInput').value += "...";
                    isDottedOnCoinSentenceInput = true;
                }
                inspectTimeCount += 1;
                var currentInspectTimeCount = inspectTimeCount;
                var value = document.getElementById("coinSentenceInput").value;
                var check = /[ㄱ-ㅎ|ㅏ-ㅣ|가-힣]/;
                setTimeout(function() {
                    var coinSentence = document.getElementById("coinSentenceInput").value;
                    console.log(nowCanRequestInput)
                    if (value === coinSentence && inspectTimeCount === currentInspectTimeCount) {
                        if (!check.test(value.slice(-1))) {
                            //document.getElementById("submitbutton").click(); // submitbutton 클릭 (translate 요청)
                            var json = {"type": "request_translate", "text": coinSentence};
                            request_input(JSON.stringify(json));
                        }
                    }
                }, 1000);
            }
            function declare() {
                var json = {"type": "declare", "coined_text": lastTranslateHistory[0], "result_text": lastTranslateHistory[1]};
                request_input(JSON.stringify(json));
                alert("번역 오류 신고가 완료되었습니다.");
            }
            
            function TTS(sentence) {
                audio = new Audio("https://code.responsivevoice.org/getvoice.php?t=" + sentence + "&tl=ko&sv=g3&vn=&pitch=0.5&rate=0.5&vol=1&gender=male");
                audio.play();
            }
            
            document.getElementById('textLength').textContent=document.getElementById('coinSentenceInput').value.length.toString() + '/' + document.getElementById('coinSentenceInput').maxLength.toString()
        </script>
        <script type="text/javascript" src="button-design.js"></script>
        <script type="text/javascript" src="textarea-auto-resize.js"></script>
    </body>
</html>
